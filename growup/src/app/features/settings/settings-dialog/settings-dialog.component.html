<div class="settings-drawer ds-scope">
  <div class="drawer-header">
    <h2 class="drawer-title">{{ 'settingsDialog.title' | translate }}</h2>
    <button mat-icon-button type="button" (click)="close()" [attr.aria-label]="'settingsDialog.close' | translate">
      <span class="material-icons">close</span>
    </button>
  </div>
  <div class="drawer-scroll">
    <form [formGroup]="form" class="dialog-form form-grid">
      <section class="settings-section" *ngIf="profiles.length">
        <div class="section-title">{{ 'profiles.listTitle' | translate }}</div>
        <div class="profiles-grid">
          <button
            type="button"
            class="profile-chip"
            *ngFor="let profile of profiles; trackBy: trackProfileById"
            [class.active]="profile.id === activeProfileId"
            (click)="onSelectProfile(profile.id)"
          >
            <img [src]="avatarOptionSrc(profile.avatarId)" alt="" />
            <span>{{ profile.displayName }}</span>
            <span class="spacer"></span>
            <button
              *ngIf="profiles.length > 1"
              type="button"
              class="profile-delete"
              aria-label="Excluir perfil"
              (click)="onDeleteProfile(profile.id, $event)"
            >
              <span class="material-icons">close</span>
            </button>
          </button>
        </div>
        <div class="avatar-row">
          <div class="avatar-preview" aria-live="polite">
            <img [src]="avatarPreviewSrc()" alt="Avatar selecionado" />
          </div>
          <div class="avatar-fields">
            <mat-form-field appearance="outline">
              <mat-label>{{ 'profiles.avatarLabel' | translate }}</mat-label>
              <mat-select formControlName="avatarId">
                <mat-option *ngFor="let avatar of avatars()" [value]="avatar.id">
                  <span class="avatar-option">
                    <img class="avatar-option-img" [src]="avatarOptionSrc(avatar.id)" alt="" />
                    {{ avatar.name }}
                  </span>
                </mat-option>
              </mat-select>
            </mat-form-field>
            <mat-form-field appearance="outline">
              <mat-label>{{ 'profiles.nameLabel' | translate }}</mat-label>
              <input matInput formControlName="displayName" maxlength="40" />
            </mat-form-field>
          </div>
        </div>
        <p class="avatar-description" *ngIf="selectedAvatarDescription()">
          {{ selectedAvatarDescription() }}
        </p>
      </section>

      <section class="settings-section">
        <div class="section-title">{{ 'settingsDialog.cycleSection' | translate }}</div>
        <div class="section-grid">
          <mat-form-field appearance="outline">
            <mat-label>{{ 'settingsDialog.cycle' | translate }}</mat-label>
            <mat-select formControlName="cycleType">
              <mat-option value="weekly">{{ 'cycle.weekly' | translate }}</mat-option>
              <mat-option value="biweekly">{{ 'cycle.biweekly' | translate }}</mat-option>
              <mat-option value="monthly">{{ 'cycle.monthly' | translate }}</mat-option>
              <mat-option value="yearly">{{ 'cycle.yearly' | translate }}</mat-option>
            </mat-select>
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>{{ 'settingsDialog.start' | translate }}</mat-label>
            <input matInput type="date" formControlName="cycleStartDate" />
          </mat-form-field>
        </div>
      </section>

      <section class="settings-section">
        <div class="section-title">{{ 'settingsDialog.levelupSection' | translate }}</div>
        <mat-form-field appearance="outline">
          <mat-label>{{ 'settingsDialog.levelUpPoints' | translate }}</mat-label>
          <input matInput type="number" min="10" formControlName="levelUpPoints" />
        </mat-form-field>
      </section>

      <section class="settings-section">
        <div class="section-title">{{ 'settingsDialog.cacheSection' | translate }}</div>
        <div class="cache-actions">
          <button mat-stroked-button type="button" (click)="clearCacheAndReload()">
            {{ 'settingsDialog.clearCache' | translate }}
          </button>
          <button mat-stroked-button class="delete-account-button" type="button" (click)="clearAllDataAndReload()">
            {{ 'settingsDialog.clearAll' | translate }}
          </button>
        </div>
        <p class="cache-warning">{{ 'settingsDialog.clearAllWarning' | translate }}</p>
      </section>


      <section class="settings-section">
        <button type="button" class="section-title log-toggle" (click)="toggleLogs()">
          <span>{{ 'settingsDialog.debugSection' | translate }}</span>
          <span class="material-icons">{{ logsOpen() ? 'expand_less' : 'expand_more' }}</span>
        </button>
        <div class="log-body" *ngIf="logsOpen()">
          <div class="cache-actions">
            <button mat-stroked-button type="button" (click)="refreshLogs()">
              {{ 'settingsDialog.refreshLogs' | translate }}
            </button>
            <button mat-stroked-button type="button" (click)="clearLogs()">
              {{ 'settingsDialog.clearLogs' | translate }}
            </button>
            <button mat-stroked-button type="button" (click)="exportLogs()">
              {{ 'settingsDialog.exportLogs' | translate }}
            </button>
            <button mat-stroked-button type="button" (click)="toggleLogging()">
              {{ loggingEnabled() ? ('settingsDialog.disableLogs' | translate) : ('settingsDialog.enableLogs' | translate) }}
            </button>
          </div>
          <mat-form-field appearance="outline" class="log-filter">
            <mat-label>{{ 'settingsDialog.logFilter' | translate }}</mat-label>
            <mat-select [value]="logLevelFilter()" (selectionChange)="onLogFilterChange($event.value)">
              <mat-option value="all">{{ 'settingsDialog.logFilterAll' | translate }}</mat-option>
              <mat-option value="debug">{{ 'settingsDialog.logFilterDebug' | translate }}</mat-option>
              <mat-option value="info">{{ 'settingsDialog.logFilterInfo' | translate }}</mat-option>
              <mat-option value="warn">{{ 'settingsDialog.logFilterWarn' | translate }}</mat-option>
              <mat-option value="error">{{ 'settingsDialog.logFilterError' | translate }}</mat-option>
            </mat-select>
          </mat-form-field>
          <div class="debug-log" *ngIf="logEntriesView().length; else noLogs">
            <div class="debug-log-item" *ngFor="let entry of logEntriesView()">
              <span class="debug-log-time">{{ entry.timestamp | date:'short' }}</span>
              <span class="debug-log-level">{{ entry.level }}</span>
              <span class="debug-log-message">{{ entry.message }}</span>
              <span class="debug-log-context" *ngIf="entry.context">{{ entry.context | json }}</span>
            </div>
          </div>
          <ng-template #noLogs>
            <p class="cache-warning">{{ 'settingsDialog.noLogs' | translate }}</p>
          </ng-template>
        </div>
      </section>
      <section class="settings-section danger-zone" *ngIf="isLoggedIn()">
        <div class="section-title danger-title">{{ 'settingsDialog.deleteAccount' | translate }}</div>
        <button
          mat-stroked-button
          class="delete-account-button"
          type="button"
          (click)="openDeleteAccount()"
        >
          {{ 'settingsDialog.deleteAccount' | translate }}
        </button>
      </section>
    </form>
  </div>
  <div class="drawer-actions">
    <button mat-button (click)="close()">{{ 'settingsDialog.cancel' | translate }}</button>
    <button mat-flat-button color="primary" (click)="save()" [disabled]="form.invalid">
      {{ 'settingsDialog.save' | translate }}
    </button>
  </div>
</div>
